#!/bin/sh

s=1 # seconds before reload
font="DejaVuSansMono-9"

# screen width
w=$(/usr/X11R6/bin/xwininfo -root|sed '/Width/!d;s/.* //')
# size of clock : 20px height, at top
geometry="${w}x20+0+0"

# some functions
ram() {
    top | grep Memory | awk {'print $3'}
}
fsperc(){
	printf "%s" "$(df -h $1 | tail -n 1 | awk '{print $5}')"
}
volperc(){
	printf "%s" "$(($(mixerctl -n outputs.master | cut -d, -f1) * 100 / 255))%"
}
loadavg(){
    uptime | awk '{print $9 $10 $11}'
}

# start
OLDPID=""
PID=""
OLDSTATUS=""
STATUS=""

RUN=0
while [ $RUN -eq 0 ]; do
	xset q > /dev/null 2>&1
	if [ $? -ne 0 ]; then
		echo "X seems off"
		RUN=1
	fi
    OLDPID=$PID
	STATUS="[ /home:$(fsperc /home)% | \
/usr/local:$(fsperc /usr/local)% ]\
 [ $(loadavg) ]\
 [ Volume:$(volperc) ]"
    if [ "${STATUS}" != "${OLDSTATUS}" ]; then
		OLDSTATUS="${STATUS}"
		xclock -render -face "${font}" -padding 3 -digital \
			-geometry "${geometry}" \
			-strftime "[ %H:%M - %d/%m/%Y ] ${STATUS} " &
		PID=$!
		sleep "${s}" 
		test -n "$OLDPID" && kill $OLDPID &
	fi
done
