#!/bin/sh
# require curl

set -e

# trads
IMGSENT="Image sent"
ERROR="Error. Check file name"


case $LANG in
	fr*)
        IMGSENT="Image envoyée"
        ERROR="Erreur à l'envoi d'image. Vérifiez le nom du fichier"
        ;;
    de*)
        IMGSENT = "Bild geschickt"
        ERROR = "Fehler. Überprüfen Sie den Dateinamen"
        ;;
    es*)
        IMGSENT = "Imagen enviada"
        ERROR = "Error. Compruebe el nombre de archivo"
        ;;
esac

TYPE="$(file --mime-type -b $1)"
EXT="${1##*.}"

# pix.toile-libre first
URL="$(curl -L --progress-bar -F "MAX_FILE_SIZE=15360000" -F "img=@${1}" "https://pix.toile-libre.org/?action=upload" |grep -E -o "http://pix.toile-libre.org/upload/original/.*\.$EXT" |head -n1)"

if [ $? -ne 0 ]; then
	URL=$(curl -F "file=@${1}" \
		-F "delete-day=0" -F "first-view=0"\
		"https://framapic.org" |grep https://framapic.org/.*? |grep 'id="share"' |grep -o "value=.*" |cut -d'"' -f2 | cut -d'?' -f1)
fi

if [ -n "${URL}" ]; then
    echo "${IMGSENT} : ${1}" &
	xmessage "
BBCode: [url=${1}][img]${1}[/img][/url]
markdown: [![](${1})](${1})
URL: ${1}
"

else
    echo "${ERROR}" &
fi


exit 0
