#!/bin/sh

# TODO or not ?
# Some man page are different on different architecture
# For a simpler interface, this is not handled as only
# the last component of path is displayed in dmenu

MANDBPATH="/usr/local/share/isotop/bin/mandb" # isotop specific

[ "$1" = "-h" ] && cat << EOF && exit 0
${0##*/} :
    pipe locate output from /var/db/man.db
    as prepopulated by mandb into dmenu.
    User can select one or more man page thanks
    to dmenu multiselection.
    Read dmenu(1) for more information ;)

    You can customize the window using the "man" class in ~/.Xdefaults
    with line such as:
        man*scrollBar: false
        man*reverseVideo: true
    
EOF

mandb=/var/db/man.db

[[ -s $mandb ]] || doas "${MANDBPATH}"
[[ -x $(which mandb) ]] || {
    print 'mandb not found!
    unable to build manpage database
'
    exit 1
}

manpage=$(locate -b -d $mandb . |sed 's,.*/,,;/mandoc.db/d' \
	|dmenu -p 'Man page : ' |uniq)

IFS='
'

[ "$manpage" ] && {
	for m in $manpage
	do
		name=${m%.([0-9]|3p)}
		section=${m##*.}
		f=$(locate -d $mandb /$m |sed q)
		[ -f "$f" ] && \
			case $section {
				0)
					xterm -class man -T "man | $name($section)" -e less -eR "$f" &
					;;
				[1-9]|3p)
					xterm -class man -T "man | $name($section)" -e man -l "$f" &
					;;
				*)
					;;
			}
	done
}

exit 0
