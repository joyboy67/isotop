#!/bin/sh

# TODO or not ?
# Some man page are different on different architecture
# For a simpler interface, this is not handled as only
# the last component of path is displayed in dmenu


[ "$1" = "-h" ] && cat << EOF && exit 0
${0##*/} :
    pipe locate output from $HOME/./man.db
    as prepopulated by mandb into dmenu.
    User can select one or more man page thanks
    to dmenu multiselection.
    Read dmenu(1) for more information ;)

    You can customize the window using the "man" class in ~/.Xresources
    with line such as:
        man*scrollBar: false
        man*reverseVideo: true
    
EOF

SP='/usr/share/man/ /usr/local/man/ /usr/X11R6/man/'
MANDB=$HOME/.man.db

[[ -s "${MANDB}" ]] || mandb
UPDATE=0
for P in $SP; do
	test -n "$(find "$P" -mmin 1)" && UPDATE=1
done
if [ $UPDATE -eq 1 ]; then
	mandb
fi
[[ -x $(which mandb) ]] || {
    print 'mandb not found!
    unable to build manpage database
'
    exit 1
}

test -s $HOME/.dmenurc && . $HOME/.dmenurc

manpage=$(locate -b -d "${MANDB}" . |sed 's,.*/,,;/mandoc.db/d' \
	|dmenu $DCOLORS -p 'Man page : ' |uniq)

IFS='
'

[ "$manpage" ] && {
	for m in $manpage
	do
		name=${m%.([0-9]|3p)}
		section=${m##*.}
		f=$(locate -d "${MANDB}" /$m |sed q)
		[ -f "$f" ] && \
			case $section {
				0)
					xterm -class man -T "man | $name($section)" -e less -eR "$f" &
					;;
				[1-9]|3p)
					xterm -class man -T "man | $name($section)" -e man -l "$f" &
					;;
				*)
					;;
			}
	done
}

exit 0
